# 03 — آجرهای سازندهٔ واقعیت افزوده (برای تازه‌کارها)
> هدف این فصل: شناخت جزء‌به‌جزءِ قطعات اساسی AR (حسگرها، ردیابی، Pose، Plane، Anchor، Raycast، مقیاس) و ارتباط آن‌ها با یک تجربهٔ پایدار و باورپذیر—بدون ورود به جزئیات پلتفرم/اپ خاص.

- **چکیده:** هر تجربهٔ AR بر دو ستون استوار است: **ردیابی دقیقِ دستگاه** و **ثبت مکانی/مقیاسیِ محتوای مجازی**. ابزارهای کلیدی شما عبارت‌اند از **Pose** (موقعیت/چرخش)، **Raycast** (یافتن نقطهٔ قرارگیری روی سطوح)، **Plane** (سطح تشخیص‌داده‌شده)، و **Anchor** (مرجع مکانی پایدار).

---

## 1) از حسگر تا صحنه: چه اتفاقی می‌افتد؟
```mermaid
flowchart LR
  CAM[دوربین RGB] -->|فریم‌ها| VIO[دیداری-اینرسیایی (VIO/SLAM)]
  IMU[IMU: شتاب/ژیرو] --> VIO
  VIO --> POSE[Pose دستگاه: موقعیت+چرخش]
  POSE --> MAP[بازسازی تقریبی از محیط (نقاط/سطوح)]
  MAP --> PLANE[تشخیص سطوح (Planes)]
  POSE --> RAY[Raycast به MAP/Planes]
  RAY --> ANCHOR[Anchorگذاری (مرجع پایدار)]
  ANCHOR --> RENDER[رندر اشیای مجازی در مکان صحیح]
```
- **VIO/SLAM**: با تطبیق الگوهای تصویری بین فریم‌ها و ادغام با IMU، حرکت/زاویهٔ دستگاه برآورد می‌شود.
- **Pose**: بردار موقعیت + چرخش (Quaternion/Euler). هر فریم به‌روزرسانی می‌شود.
- **MAP/Planes**: تصویری ساده‌شده از جهان (نقاط شاخص و سطوح تقریبی).

> اگر VIO لرزان باشد، همه‌چیز می‌لرزد—از همین رو «نور/بافت محیط» مهم است.

---

## 2) دستگاه مختصات و واحدها
- **محورهای سه‌بعدی** (Right-handed در بسیاری از موتورهای بازی): X (راست/چپ)، Y (بالا/پایین)، Z (جلو/عقب).
- **واحد اندازه‌گیری**: معمولاً **1.0 = 1 متر**. هر دادهٔ دنیای واقعی که در mm است باید تبدیل شود.
- **زاویه‌ها**: برای محاسبات پایدار از **Quaternion** استفاده می‌شود؛ نمایش/درک سادهٔ آن اغلب با Euler انجام می‌شود.

> تناقض مقیاس (Scale) بزرگ‌ترین قاتل باورپذیری است—در فصل 09 روش‌های کالیبراسیون آمده است.

---

## 3) Pose چیست و چه تفاوتی با Anchor دارد؟
- **Pose**: وضعیت لحظه‌ای دوربین/شیء نسبت به مبدأ جهان. نویزی و وابسته به فریم است.
- **Anchor**: یک **چارچوب محلی پایدار** که به یک مرجع (مثل Plane) «قفل» می‌شود تا محتوای شما جا‌به‌جا نشود.

**الگوی رایج:**
1. کاربر سطحی را می‌بیند؛ شما با **Raycast** نقطه‌ای معتبر می‌یابید.
2. یک **Anchor** در آن نقطه می‌سازید.
3. مدل/محتوای مجازی را به‌عنوان «فرزند» Anchor قرار می‌دهید.

> Anchorها را زیاد و بی‌حساب نسازید؛ هر شیء ثابت معمولاً یک Anchor کافی است.

---

## 4) Raycast: پل بین صفحهٔ لمسی و جهان سه‌بعدی
- **Raycast صفحه‌ای**: از مختصات لمس/مرکز صفحه، پرتو به صحنه/Planeها شلیک می‌شود؛ اولین برخورد → محل قرارگیری.
- **نوع هدف (Trackable Type)**: انتخاب کنید روی چه چیزی می‌خواهید «بخورید»—سطوح افقی/عمودی، نقطه‌های شاخص، یا مش‌های بازسازی‌شده.
- **Reticle/نشانک**: برای بازخورد بصری (قابل/غیرقابل-قراردهی) یک نشانک ساده به کاربر نشان دهید.

**جریان سادهٔ تصمیم:**
```mermaid
flowchart TD
  T[Tap/Pointer] --> R{Raycast موفق؟}
  R -->|نه| M[نمایش پیام/راهنما]
  R -->|بله| V{سطح معتبر؟ (زاویه/کافی بودن فضا)}
  V -->|نه| M
  V -->|بله| A[ساخت/انتقال Anchor و محتوای مجازی]
```

---

## 5) Planeها: زمین بازی شما
- **Plane Detection**: خوشه‌بندی نقاط شاخص → سطح‌های تقریبی (افقی/عمودی).
- **ویژگی‌ها**: مرکز، نرمال (جهت)، اندازهٔ تقریبی/مرز چندضلعی، اعتماد.
- **به‌روزرسانی**: Planeها ادغام/گسترش می‌یابند؛ رویدادهای «افزوده شد/به‌روزرسانی شد/حذف شد» مهم‌اند.

**نکات عملی:**
- روی **مرز** Plane قرار ندهید؛ کمی به داخل سطح بروید.
- ادغام Plane باعث «پرش» نشانک می‌شود—Anchor کردن زودهنگام کمک می‌کند.
- سطوح براق/شفاف (شیشه) برای تشخیص **بد** هستند.

---

## 6) Feature Points (Point Cloud)
- نقاط بافت‌دار قابل‌پیگیری؛ **پایدار نیستند** و مرتب تغییر می‌کنند.
- برای نمایش «کیفیت ردیابی» به کار می‌روند؛ برای **قراردهی محتوا** بهتر است از Plane استفاده کنید (مگر در سناریوهای خاص).

---

## 7) Calibration & Scale (خلاصهٔ مفهومی)
- اگر باید ابعاد واقعی را رعایت کنید، یک **نسبت تبدیل** بسازید:
  - `meters_per_mm = measured_distance_in_meters / true_distance_in_mm`
- مقیاس را به شکل **ثابت** بر کل محتوای مرتبط اعمال کنید.
- **آزمون صحّت**: یک شیء با اندازهٔ معلوم را در جهان قرار دهید و با خط‌کش/مقیاس واقعی راستی‌آزمایی کنید.

> مراقب باشید مقیاس «Origin/جهان» را بی‌حساب عوض نکنید؛ ترجیحاً مقیاس محتوای خود را تنظیم کنید.

---

## 8) نور، سایه و درک عمق (مروری کوتاه)
- **نور محیط** متغیر است؛ الگوریتم‌های برآورد روشنایی/رنگ به کمک رندر طبیعی می‌آیند.
- **سایه‌ها/وساخت**: سایهٔ نرم و تماسی (Contact Shadow) باورپذیری را بالا می‌برد—اما هزینهٔ محاسباتی دارد.
- **انسداد (Occlusion)**: پنهان شدن شیء مجازی پشت اشیای واقعی—در برخی پلتفرم‌ها پشتیبانی می‌شود (پیشرفته).

---

## 9) تعامل‌های پایه در موبایل
- **Tap/Long Press**: انتخاب/قراردهی/تایید.
- **Drag (دو بعدی روی صفحه)**: جابه‌جایی روی سطح، با نگاشت به امتداد Plane.
- **Pinch/Rotate**: مقیاس/چرخش نسبت به محور نرمال سطح.
- **Feedback**: تغییر رنگ/Outline/هاله برای حالت‌های «قابل/غیرقابل قراردهی».

> از متن‌های ۱–۲ خطی (Just-in-time) استفاده کنید؛ حالت آموزش دائمی خسته‌کننده است.

---

## 10) پایداری و خطاهای رایج
| مشکل | نشانه | ریشهٔ محتمل | راهکار |
|---|---|---|---|
| محتوای شناور/می‌لرزد | جابه‌جایی در هر حرکت دوربین | Anchor ندارید یا دیر می‌سازید | سریع Anchor کنید؛ روی Plane معتبر |
| پرش نشانک | تغییر ناگهانی محل Reticle | ادغام/به‌روزرسانی Plane | Snap را کاهش دهید؛ پس از تایید Anchor بزنید |
| مقیاس غلط | بزرگ/کوچک دیده می‌شود | تبدیل mm↔m اشتباه | دو-نقطه کالیبراسیون؛ سنجهٔ میدانی |
| FPS پایین | تاخیر/گرما | شفافیت زیاد، Instantiate مکرر | Pooling؛ کاهش Draw Calls؛ محدودکردن افکت‌ها |
| متن فارسی نادرست | حروف جدا/جهت نادرست | پشتیبانی RTL ناقص | استفاده از موتور/فونت سازگار با RTL |

---

## 11) جدول خلاصهٔ آجرها
| آجر | تعریف | ورودی/خروجی | بهترین استفاده | ضدالگو |
|---|---|---|---|---|
| Pose | وضعیت لحظه‌ای دستگاه | ویدئو+IMU → بردار/چرخش | مرجع لحظه‌ای دوربین | اتکای طولانی‌مدت بدون Anchor |
| Raycast | پرتو به صحنه/سطح | مختصات صفحه → برخورد/Pose | یافتن نقطهٔ قراردهی | نادیده‌گرفتن نوع سطح/زاویه |
| Plane | سطح تخمینی | نقاط شاخص → سطح | تکیه‌گاه قراردهی | کنار مرز/روی سطوح براق |
| Anchor | چارچوب پایدار | Pose/Plane → مرجع | قفل‌کردن محتوای ثابت | ساختن بی‌رویهٔ Anchor |
| Scale | نسبت ابعاد واقعی | فاصلهٔ سنجیده ↔ مقدار واقعی | رندر مقیاس‌دار | تغییر دلخواه مقیاس جهان |

---

## 12) چک‌لیست ذهنی قبل از پیاده‌سازی
- [ ] محیط آزمایشی نور/بافت مناسبی دارد؟
- [ ] می‌دانید کجا/چطور Raycast می‌کنید؟
- [ ] Anchor را دقیقاً کی می‌سازید/حذف می‌کنید؟
- [ ] نیاز به مقیاس واقعی دارید؟ روش تبدیل آماده است؟
- [ ] شاخص‌های کیفیت (FPS/پایداری/خوانایی) را چگونه می‌سنجید؟

---

## 13) نکات کلیدی فصل
- **Raycast → Anchor → Render**، الگوی طلایی قراردهی پایدار است.
- **Scale واقعی** را از همان ابتدا حل کنید؛ بعداً اصلاحش پرهزینه است.
- **ساده شروع کنید**: یک نشانک، یک Plane افقی، یک شیء ساده—سپس تدریجاً گسترش دهید.
- **کیفیت محیط** (نور/بافت) کیفیت تجربه را تعیین می‌کند؛ تا می‌توانید کنترلش کنید.
